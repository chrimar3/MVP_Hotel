<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:;">
    <title>üè® Hotel Review Generator</title>
    
    <style>
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --success: #059669;
            --error: #dc2626;
            --text: #1f2937;
            --text-light: #6b7280;
            --bg: #ffffff;
            --bg-light: #f9fafb;
            --border: #e5e7eb;
            --touch-target: 44px;
            --max-width: 480px;
            --border-radius: 0.5rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--bg-light);
            padding: 1rem;
            min-height: 100vh;
        }

        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            background: var(--bg);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Error display styles */
        .error-message {
            background: #fef2f2;
            border-left: 4px solid var(--error);
            color: var(--error);
            padding: 12px;
            margin: 16px;
            border-radius: 4px;
            font-size: 0.9em;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 2rem 1.5rem;
            text-align: center;
        }

        .logo-container {
            margin-bottom: 1rem;
        }

        #hotel-logo-img {
            max-height: 60px;
            max-width: 200px;
            display: none;
        }

        .logo-emoji {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* Main content */
        main {
            padding: 2rem 1.5rem;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
        }

        /* Aspects grid */
        .aspects-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        @media (min-width: 400px) {
            .aspects-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .aspect-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: var(--touch-target);
        }

        .aspect-item:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }

        .aspect-item.selected {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .aspect-checkbox {
            margin-right: 0.75rem;
            margin-top: 0.1rem;
            flex-shrink: 0;
        }

        .aspect-text {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Form inputs */
        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        input.error, textarea.error {
            border-color: var(--error);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .input-hint {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .char-counter {
            font-size: 0.8rem;
            color: var(--text-light);
            text-align: right;
            margin-top: 0.25rem;
        }

        .char-counter.warning {
            color: #d97706;
        }

        .char-counter.error {
            color: var(--error);
        }

        /* Buttons */
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: var(--touch-target);
            min-width: var(--touch-target);
        }

        .button-primary {
            background: var(--primary);
            color: white;
        }

        .button-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .button-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .button-secondary {
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .button-secondary:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .generate-section {
            text-align: center;
            padding: 2rem 0;
        }

        /* Review output */
        .review-output {
            background: var(--bg-light);
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .review-output.hidden {
            display: none;
        }

        .review-text {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            white-space: pre-line;
        }

        .review-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        @media (min-width: 400px) {
            .review-actions {
                flex-direction: row;
            }
        }

        /* Platform buttons */
        .platform-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-align: left;
        }

        .platform-emoji {
            font-size: 1.2rem;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.visible {
            transform: translateX(0);
        }

        .notification.hidden {
            transform: translateX(100%);
        }

        /* Loading state */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            .aspect-item {
                border-width: 3px;
            }
            
            .button {
                border-width: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Error Message Display -->
        <div id="error-display" class="error-message" role="alert" aria-live="polite">
            <span id="error-text"></span>
        </div>

        <!-- Header -->
        <header>
            <div class="logo-container">
                <img id="hotel-logo-img" alt="Hotel Logo" />
                <span class="logo-emoji">üè®</span>
            </div>
            <h1 id="hotel-name">Acme Hotel</h1>
            <p class="subtitle">Share your experience with other travelers</p>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Aspect Selection -->
            <section class="section">
                <h2 class="section-title">What did you love about your stay? *</h2>
                <div class="aspects-grid" id="aspects-grid" role="group" aria-labelledby="aspect-selection-title">
                    <!-- Dynamically populated -->
                </div>
                <div class="input-hint">Select the aspects that made your stay special</div>
            </section>

            <!-- Staff Recognition -->
            <section class="section">
                <div class="input-group">
                    <label for="staff-name">Special staff member to recognize</label>
                    <input 
                        type="text" 
                        id="staff-name" 
                        placeholder="e.g., Maria at reception"
                        maxlength="100"
                        aria-describedby="staff-hint staff-counter"
                    />
                    <div class="input-hint" id="staff-hint">Optional: Mention someone who made your stay extra special</div>
                    <div class="char-counter" id="staff-counter">0/100</div>
                </div>
            </section>

            <!-- Additional Comments -->
            <section class="section">
                <div class="input-group">
                    <label for="comments">Additional comments</label>
                    <textarea 
                        id="comments" 
                        placeholder="Any other thoughts about your stay?"
                        maxlength="500"
                        aria-describedby="comments-hint comments-counter"
                    ></textarea>
                    <div class="input-hint" id="comments-hint">Optional: Share any additional thoughts</div>
                    <div class="char-counter" id="comments-counter">0/500</div>
                </div>
            </section>

            <!-- Generate Button -->
            <section class="generate-section">
                <button 
                    id="generate-btn" 
                    class="button button-primary" 
                    type="button"
                    aria-describedby="generate-hint"
                >
                    <span id="generate-text">Generate My Review</span>
                    <span id="generate-spinner" class="spinner" style="display: none; margin-left: 8px;"></span>
                </button>
                <div class="input-hint" id="generate-hint">Create a personalized review based on your selections</div>
            </section>

            <!-- Review Output -->
            <section id="review-output" class="review-output hidden" role="region" aria-labelledby="review-title">
                <h2 id="review-title" class="section-title">Your Review</h2>
                <div id="review-text" class="review-text" role="article"></div>
                
                <div class="review-actions">
                    <button id="copy-btn" class="button button-secondary" type="button">
                        üìã Copy Review
                    </button>
                    <div id="platform-buttons">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Success Notification -->
    <div id="notification" class="notification hidden" role="alert" aria-live="polite">
        ‚úÖ Review copied to clipboard!
    </div>

    <script>
        'use strict';

        /**
         * Global Error Handler
         * Catches and displays user-friendly error messages
         */
        class ErrorHandler {
            static display(message, technical = '') {
                console.error('Application Error:', technical || message);
                
                const errorDisplay = document.getElementById('error-display');
                const errorText = document.getElementById('error-text');
                
                if (errorDisplay && errorText) {
                    errorText.textContent = message;
                    errorDisplay.classList.add('visible');
                    
                    // Auto-hide after 10 seconds
                    setTimeout(() => {
                        errorDisplay.classList.remove('visible');
                    }, 10000);
                }
            }

            static clear() {
                const errorDisplay = document.getElementById('error-display');
                if (errorDisplay) {
                    errorDisplay.classList.remove('visible');
                }
            }

            static handleAsync(asyncFn) {
                return async (...args) => {
                    try {
                        return await asyncFn(...args);
                    } catch (error) {
                        this.display(
                            'Something went wrong. Please try again.',
                            error.message
                        );
                        throw error;
                    }
                };
            }
        }

        /**
         * Input Validation Utilities
         * Provides comprehensive input validation and sanitization
         */
        class ValidationUtils {
            /**
             * Sanitize user input to prevent XSS
             */
            static sanitizeInput(input) {
                if (typeof input !== 'string') return '';
                
                return input
                    .replace(/[<>]/g, '') // Remove potential HTML tags
                    .replace(/javascript:/gi, '') // Remove javascript: protocol
                    .replace(/on\w+=/gi, '') // Remove event handlers
                    .trim();
            }

            /**
             * Validate staff name input
             */
            static validateStaffName(name) {
                if (!name) return { valid: true, message: '' };
                
                const sanitized = this.sanitizeInput(name);
                
                if (sanitized.length > 100) {
                    return { 
                        valid: false, 
                        message: 'Staff name must be 100 characters or less' 
                    };
                }

                if (sanitized.length < name.length) {
                    return { 
                        valid: false, 
                        message: 'Staff name contains invalid characters' 
                    };
                }

                return { valid: true, message: '', value: sanitized };
            }

            /**
             * Validate comments input
             */
            static validateComments(comments) {
                if (!comments) return { valid: true, message: '' };
                
                const sanitized = this.sanitizeInput(comments);
                
                if (sanitized.length > 500) {
                    return { 
                        valid: false, 
                        message: 'Comments must be 500 characters or less' 
                    };
                }

                if (sanitized.length < comments.length) {
                    return { 
                        valid: false, 
                        message: 'Comments contain invalid characters' 
                    };
                }

                return { valid: true, message: '', value: sanitized };
            }

            /**
             * Validate aspect selection
             */
            static validateAspectsSelection(selectedAspects) {
                if (!Array.isArray(selectedAspects)) {
                    return { 
                        valid: false, 
                        message: 'Invalid aspect selection' 
                    };
                }

                if (selectedAspects.length === 0) {
                    return { 
                        valid: false, 
                        message: 'Please select at least one aspect of your stay' 
                    };
                }

                if (selectedAspects.length > 6) {
                    return { 
                        valid: false, 
                        message: 'Please select no more than 6 aspects' 
                    };
                }

                return { valid: true, message: '' };
            }
        }

        /**
         * DOM Utilities
         * Safe DOM manipulation with error handling
         */
        class DOMUtils {
            static safeGetElement(id, required = true) {
                const element = document.getElementById(id);
                
                if (!element && required) {
                    throw new Error(`Required element not found: ${id}`);
                }
                
                return element;
            }

            static safeQuerySelector(selector, context = document) {
                try {
                    return context.querySelector(selector);
                } catch (error) {
                    console.error('Invalid selector:', selector, error);
                    return null;
                }
            }

            static safeQuerySelectorAll(selector, context = document) {
                try {
                    return context.querySelectorAll(selector);
                } catch (error) {
                    console.error('Invalid selector:', selector, error);
                    return [];
                }
            }
        }

        // Configuration with validation
        const CONFIG = {
            // Hotel Information
            hotelName: "Acme Hotel",
            hotelLogo: "", // Set to actual logo URL
            
            // Validation limits
            limits: {
                staffNameMax: 100,
                commentsMax: 500,
                aspectsMin: 1,
                aspectsMax: 6,
                notificationTimeout: 3000,
                errorTimeout: 10000
            },
            
            // Positive Aspects (checkbox options)
            aspects: {
                'clean-rooms': 'The rooms were spotlessly clean and well-maintained',
                'comfortable-beds': 'The beds were incredibly comfortable with high-quality linens',
                'great-location': 'The location was perfect for exploring the area',
                'friendly-staff': 'The staff were exceptionally friendly and helpful throughout our stay',
                'excellent-breakfast': 'The breakfast was delicious with great variety and fresh options',
                'great-value': 'Excellent value for money with outstanding service',
                'quiet-peaceful': 'The hotel was wonderfully quiet and peaceful',
                'modern-amenities': 'The amenities were modern and well-maintained'
            },
            
            // Review Templates (randomized for variety)
            openings: [
                'Had a wonderful stay at',
                'Really enjoyed our time at',
                'Excellent experience at',
                'Very pleased with our stay at',
                'Outstanding service at',
                'Thoroughly enjoyed our visit to'
            ],
            
            closings: [
                'Highly recommend this hotel to anyone visiting the area!',
                'Would definitely stay again on our next visit!',
                'Will certainly return and recommend to friends and family.',
                'Can\'t wait to come back for another stay!',
                'This hotel exceeded our expectations in every way.',
                'A truly memorable stay that we\'ll cherish.'
            ],
            
            // Platform Configuration
            platforms: {
                booking: {
                    name: 'Booking.com',
                    url: 'https://www.booking.com/reviewlist.html',
                    emoji: 'üè®'
                },
                expedia: {
                    name: 'Expedia',
                    url: 'https://www.expedia.com/user/account/trips',
                    emoji: '‚úàÔ∏è'
                },
                tripadvisor: {
                    name: 'TripAdvisor',
                    url: 'https://www.tripadvisor.com/UserReview',
                    emoji: 'üåü'
                },
                google: {
                    name: 'Google Maps',
                    url: 'https://maps.google.com',
                    emoji: 'üìç'
                }
            },
            
            // Routing Rules
            routingRules: {
                booking: { primary: 'booking', secondary: ['google', 'tripadvisor'] },
                expedia: { primary: 'expedia', secondary: ['google', 'tripadvisor'] },
                tripadvisor: { primary: 'tripadvisor', secondary: ['google', 'booking'] },
                google: { primary: 'google', secondary: ['tripadvisor', 'booking'] },
                direct: { primary: 'google', secondary: ['tripadvisor', 'booking', 'expedia'] }
            }
        };

        /**
         * Enhanced Booking Detector with Error Handling
         */
        const BookingDetector = {
            getSource() {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const source = params.get('source');
                    
                    // Validate and sanitize source parameter
                    const sanitizedSource = ValidationUtils.sanitizeInput(source || '');
                    
                    return CONFIG.routingRules[sanitizedSource] ? sanitizedSource : 'direct';
                } catch (error) {
                    console.error('Error detecting booking source:', error);
                    return 'direct';
                }
            },
            
            getSourceSafely() {
                try {
                    return this.getSource();
                } catch (error) {
                    ErrorHandler.display('Unable to detect booking source', error.message);
                    return 'direct';
                }
            },
            
            getPlatformRouting() {
                try {
                    const source = this.getSourceSafely();
                    return CONFIG.routingRules[source] || CONFIG.routingRules.direct;
                } catch (error) {
                    console.error('Error getting platform routing:', error);
                    return CONFIG.routingRules.direct;
                }
            }
        };

        /**
         * Enhanced Review Builder with Validation
         */
        const ReviewBuilder = {
            generate() {
                try {
                    ErrorHandler.clear();
                    
                    const aspects = this.getSelectedAspects();
                    const staffName = this.getStaffName();
                    const comments = this.getComments();
                    
                    // Validate all inputs
                    const validation = this.validateInputs(aspects, staffName, comments);
                    if (!validation.valid) {
                        ErrorHandler.display(validation.message);
                        return null;
                    }
                    
                    return this.assembleReview(aspects, staffName, comments);
                } catch (error) {
                    ErrorHandler.display('Unable to generate review', error.message);
                    return null;
                }
            },
            
            getSelectedAspects() {
                const checked = DOMUtils.safeQuerySelectorAll('input[type="checkbox"]:checked');
                return Array.from(checked)
                    .map(cb => CONFIG.aspects[cb.value])
                    .filter(Boolean);
            },
            
            getStaffName() {
                const input = DOMUtils.safeGetElement('staff-name', false);
                return input ? ValidationUtils.sanitizeInput(input.value.trim()) : '';
            },
            
            getComments() {
                const input = DOMUtils.safeGetElement('comments', false);
                return input ? ValidationUtils.sanitizeInput(input.value.trim()) : '';
            },
            
            validateInputs(aspects, staffName, comments) {
                // Validate aspects
                const aspectValidation = ValidationUtils.validateAspectsSelection(aspects);
                if (!aspectValidation.valid) {
                    return aspectValidation;
                }
                
                // Validate staff name
                const staffValidation = ValidationUtils.validateStaffName(staffName);
                if (!staffValidation.valid) {
                    return staffValidation;
                }
                
                // Validate comments
                const commentsValidation = ValidationUtils.validateComments(comments);
                if (!commentsValidation.valid) {
                    return commentsValidation;
                }
                
                return { valid: true };
            },
            
            assembleReview(aspects, staffName, comments) {
                const parts = [];
                
                // Random opening
                const opening = CONFIG.openings[Math.floor(Math.random() * CONFIG.openings.length)];
                parts.push(`${opening} ${CONFIG.hotelName}!`);
                
                // Aspects
                if (aspects.length > 0) {
                    parts.push(this.formatAspects(aspects));
                } else {
                    parts.push('Everything about our stay was excellent and exceeded our expectations.');
                }
                
                // Staff recognition
                if (staffName) {
                    parts.push(`Special thanks to ${staffName} who made our stay extra special.`);
                }
                
                // Additional comments
                if (comments) {
                    parts.push(comments);
                }
                
                // Random closing
                const closing = CONFIG.closings[Math.floor(Math.random() * CONFIG.closings.length)];
                parts.push(closing);
                
                return parts.join(' ');
            },
            
            formatAspects(aspects) {
                if (aspects.length === 1) {
                    return aspects[0] + '.';
                }
                
                if (aspects.length === 2) {
                    const first = aspects[0];
                    const second = aspects[1].charAt(0).toLowerCase() + aspects[1].slice(1);
                    return `${first}, and ${second}.`;
                }
                
                const aspectsCopy = [...aspects];
                const last = aspectsCopy.pop();
                const lastFormatted = last.charAt(0).toLowerCase() + last.slice(1);
                
                return `${aspectsCopy.join(', ')}, and ${lastFormatted}.`;
            }
        };

        /**
         * Enhanced Clipboard Manager with Error Handling
         */
        const ClipboardManager = {
            async copy(text) {
                if (!text || typeof text !== 'string') {
                    throw new Error('Invalid text to copy');
                }
                
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(text);
                        this.showNotification();
                    } else {
                        this.fallbackCopy(text);
                    }
                } catch (err) {
                    console.error('Modern clipboard failed:', err);
                    this.fallbackCopy(text);
                }
            },
            
            copyWithErrorHandling: ErrorHandler.handleAsync(async function(text) {
                await ClipboardManager.copy(text);
            }),
            
            fallbackCopy(text) {
                try {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    
                    textarea.focus();
                    textarea.select();
                    
                    const successful = document.execCommand('copy');
                    if (successful) {
                        this.showNotification();
                    } else {
                        throw new Error('Fallback copy command failed');
                    }
                    
                    document.body.removeChild(textarea);
                } catch (err) {
                    ErrorHandler.display('Unable to copy to clipboard. Please select and copy the text manually.');
                    console.error('Fallback copy failed:', err);
                }
            },
            
            showNotification() {
                const toast = DOMUtils.safeGetElement('notification', false);
                if (toast) {
                    toast.classList.remove('hidden');
                    toast.classList.add('visible');
                    setTimeout(() => {
                        toast.classList.remove('visible');
                        toast.classList.add('hidden');
                    }, CONFIG.limits.notificationTimeout);
                }
            }
        };

        /**
         * Enhanced UI Controller with Comprehensive Error Handling
         */
        const UIController = {
            // Cache DOM elements for performance
            elements: {},
            
            init() {
                try {
                    this.cacheElements();
                    this.renderAspects();
                    this.setupEventListeners();
                    this.updateHotelName();
                    this.setupInputValidation();
                    
                    // Debug: Log booking source
                    console.log('Booking source detected:', BookingDetector.getSourceSafely());
                    
                    return true;
                } catch (error) {
                    ErrorHandler.display(
                        'Application failed to initialize. Please refresh the page.',
                        error.message
                    );
                    return false;
                }
            },
            
            cacheElements() {
                const elementIds = [
                    'aspects-grid', 'staff-name', 'comments', 'generate-btn',
                    'copy-btn', 'review-output', 'review-text', 'platform-buttons',
                    'hotel-name', 'hotel-logo-img', 'notification', 'error-display',
                    'staff-counter', 'comments-counter', 'generate-text', 'generate-spinner'
                ];
                
                elementIds.forEach(id => {
                    this.elements[id] = DOMUtils.safeGetElement(id, false);
                });
            },
            
            renderAspects() {
                const grid = this.elements['aspects-grid'];
                if (!grid) {
                    throw new Error('Aspects grid element not found');
                }
                
                grid.innerHTML = '';
                
                Object.entries(CONFIG.aspects).forEach(([key, text]) => {
                    const aspectItem = this.createAspectItem(key, text);
                    grid.appendChild(aspectItem);
                });
            },
            
            createAspectItem(key, text) {
                const div = document.createElement('div');
                div.className = 'aspect-item';
                div.setAttribute('role', 'checkbox');
                div.setAttribute('aria-checked', 'false');
                div.setAttribute('tabindex', '0');
                
                div.innerHTML = `
                    <input type="checkbox" value="${key}" class="aspect-checkbox" id="aspect-${key}">
                    <label for="aspect-${key}" class="aspect-text">${text}</label>
                `;
                
                // Add click and keyboard event handlers
                div.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = div.querySelector('input[type="checkbox"]');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            this.updateAspectSelection(div, checkbox.checked);
                        }
                    } else {
                        this.updateAspectSelection(div, e.target.checked);
                    }
                });
                
                div.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        div.click();
                    }
                });
                
                return div;
            },
            
            updateAspectSelection(aspectItem, isSelected) {
                aspectItem.classList.toggle('selected', isSelected);
                aspectItem.setAttribute('aria-checked', isSelected.toString());
                ErrorHandler.clear(); // Clear any previous validation errors
            },
            
            setupEventListeners() {
                // Generate button
                if (this.elements['generate-btn']) {
                    this.elements['generate-btn'].addEventListener('click', 
                        ErrorHandler.handleAsync(() => this.handleGenerate())
                    );
                }
                
                // Copy button
                if (this.elements['copy-btn']) {
                    this.elements['copy-btn'].addEventListener('click', 
                        ErrorHandler.handleAsync(() => this.handleCopy())
                    );
                }
                
                // Input validation
                ['staff-name', 'comments'].forEach(inputId => {
                    const input = this.elements[inputId];
                    if (input) {
                        input.addEventListener('input', () => this.validateInput(inputId));
                        input.addEventListener('blur', () => this.validateInput(inputId));
                    }
                });
            },
            
            setupInputValidation() {
                // Character counters
                this.setupCharacterCounter('staff-name', 'staff-counter', CONFIG.limits.staffNameMax);
                this.setupCharacterCounter('comments', 'comments-counter', CONFIG.limits.commentsMax);
            },
            
            setupCharacterCounter(inputId, counterId, maxLength) {
                const input = this.elements[inputId];
                const counter = this.elements[counterId];
                
                if (input && counter) {
                    const updateCounter = () => {
                        const length = input.value.length;
                        counter.textContent = `${length}/${maxLength}`;
                        
                        // Update styling based on length
                        counter.classList.remove('warning', 'error');
                        if (length > maxLength * 0.8) {
                            counter.classList.add('warning');
                        }
                        if (length > maxLength) {
                            counter.classList.add('error');
                        }
                    };
                    
                    input.addEventListener('input', updateCounter);
                    updateCounter(); // Initialize
                }
            },
            
            validateInput(inputId) {
                const input = this.elements[inputId];
                if (!input) return;
                
                const value = input.value;
                let validation;
                
                switch (inputId) {
                    case 'staff-name':
                        validation = ValidationUtils.validateStaffName(value);
                        break;
                    case 'comments':
                        validation = ValidationUtils.validateComments(value);
                        break;
                    default:
                        return;
                }
                
                // Update input styling
                input.classList.toggle('error', !validation.valid);
                
                // Show validation message if invalid
                if (!validation.valid) {
                    ErrorHandler.display(validation.message);
                } else {
                    ErrorHandler.clear();
                }
            },
            
            updateHotelName() {
                const hotelNameElement = this.elements['hotel-name'];
                if (hotelNameElement) {
                    hotelNameElement.textContent = CONFIG.hotelName;
                }
                
                // Set logo if provided
                if (CONFIG.hotelLogo && this.elements['hotel-logo-img']) {
                    const logoImg = this.elements['hotel-logo-img'];
                    logoImg.src = CONFIG.hotelLogo;
                    logoImg.style.display = 'block';
                    if (logoImg.nextElementSibling) {
                        logoImg.nextElementSibling.style.display = 'none';
                    }
                }
            },
            
            async handleGenerate() {
                const generateBtn = this.elements['generate-btn'];
                const generateText = this.elements['generate-text'];
                const generateSpinner = this.elements['generate-spinner'];
                
                // Show loading state
                if (generateBtn) generateBtn.disabled = true;
                if (generateText) generateText.textContent = 'Generating...';
                if (generateSpinner) generateSpinner.style.display = 'inline-block';
                
                try {
                    // Add small delay for better UX
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const review = ReviewBuilder.generate();
                    if (review) {
                        this.displayReview(review);
                        this.setupPlatformButtons();
                        this.scrollToReview();
                    }
                } finally {
                    // Reset loading state
                    if (generateBtn) generateBtn.disabled = false;
                    if (generateText) generateText.textContent = 'Generate My Review';
                    if (generateSpinner) generateSpinner.style.display = 'none';
                }
            },
            
            displayReview(review) {
                const reviewText = this.elements['review-text'];
                const reviewOutput = this.elements['review-output'];
                
                if (reviewText) {
                    reviewText.textContent = review;
                }
                
                if (reviewOutput) {
                    reviewOutput.classList.remove('hidden');
                }
            },
            
            async handleCopy() {
                const reviewText = this.elements['review-text'];
                if (reviewText) {
                    await ClipboardManager.copyWithErrorHandling(reviewText.textContent);
                }
            },
            
            setupPlatformButtons() {
                const buttonsContainer = this.elements['platform-buttons'];
                if (!buttonsContainer) return;
                
                const routing = BookingDetector.getPlatformRouting();
                buttonsContainer.innerHTML = '';
                
                // Primary platform button
                if (routing.primary && CONFIG.platforms[routing.primary]) {
                    const primaryButton = this.createPlatformButton(
                        CONFIG.platforms[routing.primary], 
                        true
                    );
                    buttonsContainer.appendChild(primaryButton);
                }
                
                // Secondary platform buttons
                if (routing.secondary && Array.isArray(routing.secondary)) {
                    routing.secondary.forEach(platformKey => {
                        if (CONFIG.platforms[platformKey]) {
                            const button = this.createPlatformButton(
                                CONFIG.platforms[platformKey], 
                                false
                            );
                            buttonsContainer.appendChild(button);
                        }
                    });
                }
            },
            
            createPlatformButton(platform, isPrimary) {
                const button = document.createElement('a');
                button.href = platform.url;
                button.target = '_blank';
                button.rel = 'noopener noreferrer';
                button.className = `button platform-button ${isPrimary ? 'button-primary' : 'button-secondary'}`;
                button.setAttribute('aria-label', `Submit review on ${platform.name}`);
                
                button.innerHTML = `
                    <span class="platform-emoji">${platform.emoji}</span>
                    <span>Review on ${platform.name}</span>
                `;
                
                return button;
            },
            
            scrollToReview() {
                const reviewOutput = this.elements['review-output'];
                if (reviewOutput) {
                    reviewOutput.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        };

        // Global error handling
        window.addEventListener('error', (event) => {
            console.error('Uncaught error:', event.error);
            ErrorHandler.display(
                'An unexpected error occurred. Please refresh the page and try again.',
                event.error?.message
            );
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            ErrorHandler.display(
                'An unexpected error occurred. Please try again.',
                event.reason?.message
            );
        });

        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const initialized = UIController.init();
                if (!initialized) {
                    throw new Error('Failed to initialize application');
                }
                console.log('Hotel Review Generator initialized successfully');
            } catch (error) {
                console.error('Failed to initialize:', error);
                ErrorHandler.display(
                    'Application failed to start. Please refresh the page.',
                    error.message
                );
            }
        });

        // Expose utilities for testing (only in development)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.HotelReviewApp = {
                ErrorHandler,
                ValidationUtils,
                DOMUtils,
                BookingDetector,
                ReviewBuilder,
                ClipboardManager,
                UIController,
                CONFIG
            };
        }
    </script>
</body>
</html>