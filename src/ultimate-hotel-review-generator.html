<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com; img-src 'self' data: https:; connect-src 'self' https://www.google-analytics.com;">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    
    <title>🏨 Hotel Review Generator - Ultimate Edition</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>
    
    <style>
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --success: #059669;
            --error: #dc2626;
            --warning: #d97706;
            --text: #1f2937;
            --text-light: #6b7280;
            --bg: #ffffff;
            --bg-light: #f9fafb;
            --border: #e5e7eb;
            --touch-target: 44px;
            --max-width: 480px;
            --border-radius: 0.5rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--bg-light);
            padding: 1rem;
            min-height: 100vh;
        }

        /* Language Selector */
        .language-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }

        .language-selector select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid var(--border);
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        /* Container */
        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            background: var(--bg);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }

        /* PWA Install Button */
        .install-button {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            z-index: 1000;
            border: none;
            font-weight: 500;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); }
            to { transform: translateY(0); }
        }

        .install-button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Offline Banner */
        .offline-banner {
            display: none;
            background: var(--warning);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }

        .offline-banner.visible {
            display: block;
        }

        /* Analytics Badge */
        .analytics-badge {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .analytics-badge .dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Error display */
        .error-message {
            background: #fef2f2;
            border-left: 4px solid var(--error);
            color: var(--error);
            padding: 12px;
            margin: 16px;
            border-radius: 4px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 2rem 1.5rem;
            text-align: center;
        }

        /* Main content */
        main {
            padding: 2rem 1.5rem;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Aspects grid */
        .aspects-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        @media (min-width: 400px) {
            .aspects-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .aspect-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: var(--touch-target);
        }

        .aspect-item:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }

        .aspect-item.selected {
            border-color: var(--primary);
            background: #eff6ff;
        }

        /* Form inputs */
        input[type="text"], textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-family: inherit;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .char-counter {
            font-size: 0.8rem;
            color: var(--text-light);
            text-align: right;
            margin-top: 0.25rem;
        }

        /* Buttons */
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: var(--touch-target);
        }

        .button-primary {
            background: var(--primary);
            color: white;
        }

        .button-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .button-secondary {
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
        }

        /* Review output */
        .review-output {
            background: var(--bg-light);
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .review-output.hidden {
            display: none;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.visible {
            transform: translateX(0);
        }

        /* RTL Support */
        [dir="rtl"] {
            text-align: right;
        }

        [dir="rtl"] .language-selector {
            left: 10px;
            right: auto;
        }

        [dir="rtl"] .analytics-badge {
            right: 10px;
            left: auto;
        }
    </style>
</head>
<body>
    <!-- Offline Banner -->
    <div id="offline-banner" class="offline-banner">
        <span data-i18n="offline_message">📱 You're offline - but the app still works!</span>
    </div>

    <!-- Language Selector -->
    <div class="language-selector">
        <select id="language-select" aria-label="Select Language">
            <option value="en">🇬🇧 English</option>
            <option value="el">🇬🇷 Ελληνικά</option>
            <option value="es">🇪🇸 Español</option>
            <option value="fr">🇫🇷 Français</option>
            <option value="de">🇩🇪 Deutsch</option>
            <option value="it">🇮🇹 Italiano</option>
            <option value="pt">🇵🇹 Português</option>
            <option value="zh">🇨🇳 中文</option>
            <option value="ja">🇯🇵 日本語</option>
            <option value="ar">🇸🇦 العربية</option>
        </select>
    </div>

    <div class="container">
        <!-- Error Display -->
        <div id="error-display" class="error-message" role="alert">
            <span id="error-text"></span>
        </div>

        <!-- Header -->
        <header>
            <h1 id="hotel-name">Acme Hotel</h1>
            <p class="subtitle" data-i18n="subtitle">Share your experience with other travelers</p>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Aspects Section -->
            <section class="section">
                <h2 class="section-title" data-i18n="aspects_title">What did you love about your stay?</h2>
                <div class="aspects-grid" id="aspects-grid"></div>
            </section>

            <!-- Staff Recognition -->
            <section class="section">
                <label for="staff-name" data-i18n="staff_label">Special staff member to recognize</label>
                <input type="text" id="staff-name" maxlength="100" data-i18n-placeholder="staff_placeholder">
                <div class="char-counter" id="staff-counter">0/100</div>
            </section>

            <!-- Comments -->
            <section class="section">
                <label for="comments" data-i18n="comments_label">Additional comments</label>
                <textarea id="comments" maxlength="500" data-i18n-placeholder="comments_placeholder"></textarea>
                <div class="char-counter" id="comments-counter">0/500</div>
            </section>

            <!-- Generate Button -->
            <section style="text-align: center;">
                <button id="generate-btn" class="button button-primary">
                    <span data-i18n="generate_button">Generate My Review</span>
                </button>
            </section>

            <!-- Review Output -->
            <section id="review-output" class="review-output hidden">
                <h2 data-i18n="review_title">Your Review</h2>
                <div id="review-text" style="margin: 1rem 0; white-space: pre-line;"></div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="copy-btn" class="button button-secondary">
                        📋 <span data-i18n="copy_button">Copy Review</span>
                    </button>
                    <div id="platform-buttons"></div>
                </div>
            </section>
        </main>

        <!-- Analytics Badge -->
        <div class="analytics-badge">
            <span class="dot"></span>
            <span data-i18n="analytics_active">Analytics Active</span>
        </div>
    </div>

    <!-- PWA Install Button -->
    <button id="install-button" class="install-button">
        📲 <span data-i18n="install_app">Install App</span>
    </button>

    <!-- Success Notification -->
    <div id="notification" class="notification">
        ✅ <span data-i18n="copied_message">Review copied!</span>
    </div>

    <script>
        'use strict';

        /**
         * Phase 1: Analytics Module
         * Comprehensive tracking for conversion optimization
         */
        class HotelAnalytics {
            constructor() {
                this.events = [];
                this.sessionStart = Date.now();
                this.funnelSteps = new Set();
                this.isDNT = navigator.doNotTrack === '1';
                
                // Initialize GA if available
                this.ga = typeof gtag !== 'undefined' ? gtag : null;
            }

            trackPageView() {
                if (this.respectsPrivacy()) return true;
                
                const event = {
                    type: 'pageview',
                    timestamp: Date.now(),
                    url: window.location.href,
                    referrer: document.referrer
                };
                
                this.events.push(event);
                this.sendToGA('page_view', {
                    page_location: window.location.href
                });
                
                return true;
            }

            trackReviewGenerated(data) {
                if (this.respectsPrivacy()) return true;
                
                const event = {
                    type: 'review_generated',
                    timestamp: Date.now(),
                    timeToGenerate: Date.now() - this.sessionStart,
                    ...data
                };
                
                this.events.push(event);
                this.funnelSteps.add('review_generated');
                
                this.sendToGA('generate_review', {
                    aspects_count: data.aspects?.length || 0,
                    has_staff_mention: data.hasStaffMention,
                    has_comments: data.hasComments,
                    platform: data.platform
                });
                
                return true;
            }

            trackPlatformClick(platform) {
                if (this.respectsPrivacy()) return true;
                
                const event = {
                    type: 'platform_click',
                    timestamp: Date.now(),
                    platform
                };
                
                this.events.push(event);
                this.funnelSteps.add('platform_clicked');
                
                this.sendToGA('select_platform', {
                    platform_name: platform
                });
                
                return true;
            }

            trackReviewCopied() {
                if (this.respectsPrivacy()) return true;
                
                const event = {
                    type: 'review_copied',
                    timestamp: Date.now()
                };
                
                this.events.push(event);
                this.funnelSteps.add('review_copied');
                
                this.sendToGA('copy_review', {
                    time_to_copy: Date.now() - this.sessionStart
                });
                
                return true;
            }

            trackFunnelStep(step) {
                if (this.respectsPrivacy()) return true;
                
                this.funnelSteps.add(step);
                
                const event = {
                    type: 'funnel_step',
                    timestamp: Date.now(),
                    step,
                    stepNumber: this.funnelSteps.size
                };
                
                this.events.push(event);
                
                this.sendToGA('funnel_step', {
                    step_name: step,
                    step_number: this.funnelSteps.size
                });
                
                return true;
            }

            trackEvent(category, action, label, value) {
                if (this.respectsPrivacy()) return true;
                
                const event = {
                    type: 'custom',
                    timestamp: Date.now(),
                    category,
                    action,
                    label,
                    value
                };
                
                this.events.push(event);
                
                this.sendToGA('custom_event', {
                    event_category: category,
                    event_action: action,
                    event_label: label,
                    value: value
                });
                
                return true;
            }

            getSessionMetrics() {
                const now = Date.now();
                return {
                    sessionDuration: now - this.sessionStart,
                    timeToGenerate: this.events.find(e => e.type === 'review_generated')?.timeToGenerate || null,
                    eventsCount: this.events.length,
                    funnelCompletion: this.funnelSteps.size,
                    conversionRate: this.funnelSteps.has('platform_clicked') ? 100 : 0
                };
            }

            flushEvents() {
                const toFlush = [...this.events];
                this.events = [];
                
                // In production, send to analytics endpoint
                console.log('Analytics batch:', toFlush);
                
                return toFlush;
            }

            respectsPrivacy() {
                return this.isDNT;
            }

            sendToGA(eventName, parameters) {
                if (this.ga && !this.isDNT) {
                    this.ga('event', eventName, parameters);
                }
            }
        }

        /**
         * Phase 2: Internationalization (i18n) Module
         * Multi-language support with automatic detection
         */
        class I18n {
            constructor() {
                this.currentLang = this.detectLanguage();
                this.translations = {
                    en: {
                        subtitle: "Share your experience with other travelers",
                        aspects_title: "What did you love about your stay?",
                        staff_label: "Special staff member to recognize",
                        staff_placeholder: "e.g., Maria at reception",
                        comments_label: "Additional comments",
                        comments_placeholder: "Any other thoughts about your stay?",
                        generate_button: "Generate My Review",
                        review_title: "Your Review",
                        copy_button: "Copy Review",
                        copied_message: "Review copied!",
                        install_app: "Install App",
                        offline_message: "📱 You're offline - but the app still works!",
                        analytics_active: "Analytics Active",
                        // Aspects
                        clean_rooms: "The rooms were spotlessly clean and well-maintained",
                        comfortable_beds: "The beds were incredibly comfortable",
                        great_location: "The location was perfect for exploring",
                        friendly_staff: "The staff were exceptionally friendly and helpful",
                        excellent_breakfast: "The breakfast was delicious with great variety",
                        great_value: "Excellent value for money",
                        quiet_peaceful: "The hotel was wonderfully quiet and peaceful",
                        modern_amenities: "The amenities were modern and well-maintained",
                        // Review templates
                        opening_1: "Had a wonderful stay at",
                        opening_2: "Really enjoyed our time at",
                        opening_3: "Excellent experience at",
                        closing_1: "Highly recommend this hotel!",
                        closing_2: "Would definitely stay again!",
                        closing_3: "Will certainly return!"
                    },
                    es: {
                        subtitle: "Comparte tu experiencia con otros viajeros",
                        aspects_title: "¿Qué te encantó de tu estancia?",
                        staff_label: "Personal especial para reconocer",
                        staff_placeholder: "ej., María en recepción",
                        comments_label: "Comentarios adicionales",
                        comments_placeholder: "¿Algún otro pensamiento sobre tu estancia?",
                        generate_button: "Generar Mi Reseña",
                        review_title: "Tu Reseña",
                        copy_button: "Copiar Reseña",
                        copied_message: "¡Reseña copiada!",
                        install_app: "Instalar App",
                        offline_message: "📱 Estás sin conexión - ¡pero la app sigue funcionando!",
                        analytics_active: "Análisis Activo",
                        clean_rooms: "Las habitaciones estaban impecablemente limpias",
                        comfortable_beds: "Las camas eran increíblemente cómodas",
                        great_location: "La ubicación era perfecta para explorar",
                        friendly_staff: "El personal fue excepcionalmente amable",
                        excellent_breakfast: "El desayuno fue delicioso con gran variedad",
                        great_value: "Excelente relación calidad-precio",
                        quiet_peaceful: "El hotel era maravillosamente tranquilo",
                        modern_amenities: "Las comodidades eran modernas",
                        opening_1: "Tuve una estancia maravillosa en",
                        opening_2: "Realmente disfruté mi tiempo en",
                        opening_3: "Excelente experiencia en",
                        closing_1: "¡Recomiendo mucho este hotel!",
                        closing_2: "¡Definitivamente me quedaría de nuevo!",
                        closing_3: "¡Ciertamente regresaré!"
                    },
                    fr: {
                        subtitle: "Partagez votre expérience avec d'autres voyageurs",
                        aspects_title: "Qu'avez-vous aimé dans votre séjour?",
                        staff_label: "Personnel spécial à reconnaître",
                        staff_placeholder: "ex., Marie à la réception",
                        comments_label: "Commentaires supplémentaires",
                        comments_placeholder: "D'autres réflexions sur votre séjour?",
                        generate_button: "Générer Mon Avis",
                        review_title: "Votre Avis",
                        copy_button: "Copier l'Avis",
                        copied_message: "Avis copié!",
                        install_app: "Installer l'App",
                        offline_message: "📱 Vous êtes hors ligne - mais l'app fonctionne toujours!",
                        analytics_active: "Analyse Active",
                        clean_rooms: "Les chambres étaient impeccablement propres",
                        comfortable_beds: "Les lits étaient incroyablement confortables",
                        great_location: "L'emplacement était parfait pour explorer",
                        friendly_staff: "Le personnel était exceptionnellement sympathique",
                        excellent_breakfast: "Le petit-déjeuner était délicieux avec une grande variété",
                        great_value: "Excellent rapport qualité-prix",
                        quiet_peaceful: "L'hôtel était merveilleusement calme",
                        modern_amenities: "Les équipements étaient modernes",
                        opening_1: "J'ai passé un merveilleux séjour à",
                        opening_2: "J'ai vraiment apprécié mon temps à",
                        opening_3: "Excellente expérience à",
                        closing_1: "Je recommande vivement cet hôtel!",
                        closing_2: "Je reviendrais certainement!",
                        closing_3: "Je reviendrai certainement!"
                    },
                    de: {
                        subtitle: "Teilen Sie Ihre Erfahrung mit anderen Reisenden",
                        aspects_title: "Was hat Ihnen an Ihrem Aufenthalt gefallen?",
                        staff_label: "Besonderes Personal zur Anerkennung",
                        staff_placeholder: "z.B., Maria an der Rezeption",
                        comments_label: "Zusätzliche Kommentare",
                        comments_placeholder: "Weitere Gedanken zu Ihrem Aufenthalt?",
                        generate_button: "Meine Bewertung Erstellen",
                        review_title: "Ihre Bewertung",
                        copy_button: "Bewertung Kopieren",
                        copied_message: "Bewertung kopiert!",
                        install_app: "App Installieren",
                        offline_message: "📱 Sie sind offline - aber die App funktioniert trotzdem!",
                        analytics_active: "Analyse Aktiv",
                        clean_rooms: "Die Zimmer waren makellos sauber",
                        comfortable_beds: "Die Betten waren unglaublich bequem",
                        great_location: "Die Lage war perfekt zum Erkunden",
                        friendly_staff: "Das Personal war außergewöhnlich freundlich",
                        excellent_breakfast: "Das Frühstück war köstlich mit großer Auswahl",
                        great_value: "Ausgezeichnetes Preis-Leistungs-Verhältnis",
                        quiet_peaceful: "Das Hotel war wunderbar ruhig",
                        modern_amenities: "Die Annehmlichkeiten waren modern",
                        opening_1: "Hatte einen wunderbaren Aufenthalt im",
                        opening_2: "Habe meine Zeit im wirklich genossen",
                        opening_3: "Ausgezeichnete Erfahrung im",
                        closing_1: "Ich empfehle dieses Hotel sehr!",
                        closing_2: "Würde definitiv wieder hier übernachten!",
                        closing_3: "Werde sicherlich zurückkehren!"
                    },
                    it: {
                        subtitle: "Condividi la tua esperienza con altri viaggiatori",
                        aspects_title: "Cosa ti è piaciuto del tuo soggiorno?",
                        staff_label: "Personale speciale da riconoscere",
                        staff_placeholder: "es., Maria alla reception",
                        comments_label: "Commenti aggiuntivi",
                        comments_placeholder: "Altri pensieri sul tuo soggiorno?",
                        generate_button: "Genera La Mia Recensione",
                        review_title: "La Tua Recensione",
                        copy_button: "Copia Recensione",
                        copied_message: "Recensione copiata!",
                        install_app: "Installa App",
                        offline_message: "📱 Sei offline - ma l'app funziona ancora!",
                        analytics_active: "Analisi Attiva",
                        clean_rooms: "Le camere erano perfettamente pulite",
                        comfortable_beds: "I letti erano incredibilmente comodi",
                        great_location: "La posizione era perfetta per esplorare",
                        friendly_staff: "Il personale era eccezionalmente cordiale",
                        excellent_breakfast: "La colazione era deliziosa con grande varietà",
                        great_value: "Eccellente rapporto qualità-prezzo",
                        quiet_peaceful: "L'hotel era meravigliosamente tranquillo",
                        modern_amenities: "I servizi erano moderni",
                        opening_1: "Ho avuto un soggiorno meraviglioso a",
                        opening_2: "Ho davvero apprezzato il mio tempo a",
                        opening_3: "Esperienza eccellente a",
                        closing_1: "Consiglio vivamente questo hotel!",
                        closing_2: "Ci tornerei sicuramente!",
                        closing_3: "Tornerò sicuramente!"
                    },
                    ar: {
                        subtitle: "شارك تجربتك مع المسافرين الآخرين",
                        aspects_title: "ما الذي أحببته في إقامتك؟",
                        staff_label: "موظف مميز للتقدير",
                        staff_placeholder: "مثال: ماريا في الاستقبال",
                        comments_label: "تعليقات إضافية",
                        comments_placeholder: "أي أفكار أخرى حول إقامتك؟",
                        generate_button: "إنشاء مراجعتي",
                        review_title: "مراجعتك",
                        copy_button: "نسخ المراجعة",
                        copied_message: "تم نسخ المراجعة!",
                        install_app: "تثبيت التطبيق",
                        offline_message: "📱 أنت غير متصل - لكن التطبيق لا يزال يعمل!",
                        analytics_active: "التحليلات نشطة",
                        clean_rooms: "كانت الغرف نظيفة تمامًا",
                        comfortable_beds: "كانت الأسرّة مريحة للغاية",
                        great_location: "كان الموقع مثاليًا للاستكشاف",
                        friendly_staff: "كان الموظفون ودودين للغاية",
                        excellent_breakfast: "كان الإفطار لذيذًا مع تنوع كبير",
                        great_value: "قيمة ممتازة مقابل المال",
                        quiet_peaceful: "كان الفندق هادئًا بشكل رائع",
                        modern_amenities: "كانت المرافق حديثة",
                        opening_1: "قضيت إقامة رائعة في",
                        opening_2: "استمتعت حقًا بوقتي في",
                        opening_3: "تجربة ممتازة في",
                        closing_1: "أوصي بشدة بهذا الفندق!",
                        closing_2: "سأقيم هنا مرة أخرى بالتأكيد!",
                        closing_3: "سأعود بالتأكيد!"
                    },
                    el: {
                        subtitle: "Μοιραστείτε την εμπειρία σας με άλλους ταξιδιώτες",
                        aspects_title: "Τι σας άρεσε στη διαμονή σας;",
                        staff_label: "Ειδικό μέλος προσωπικού για αναγνώριση",
                        staff_placeholder: "π.χ., Μαρία στη ρεσεψιόν",
                        comments_label: "Επιπλέον σχόλια",
                        comments_placeholder: "Άλλες σκέψεις για τη διαμονή σας;",
                        generate_button: "Δημιουργία Κριτικής",
                        review_title: "Η Κριτική σας",
                        copy_button: "Αντιγραφή Κριτικής",
                        copied_message: "Η κριτική αντιγράφηκε!",
                        install_app: "Εγκατάσταση Εφαρμογής",
                        offline_message: "📱 Είστε εκτός σύνδεσης - αλλά η εφαρμογή λειτουργεί!",
                        analytics_active: "Αναλυτικά Ενεργά",
                        clean_rooms: "Τα δωμάτια ήταν άψογα καθαρά και καλοδιατηρημένα",
                        comfortable_beds: "Τα κρεβάτια ήταν απίστευτα άνετα με υψηλής ποιότητας σεντόνια",
                        great_location: "Η τοποθεσία ήταν ιδανική για εξερεύνηση της περιοχής",
                        friendly_staff: "Το προσωπικό ήταν εξαιρετικά φιλικό και εξυπηρετικό",
                        excellent_breakfast: "Το πρωινό ήταν νόστιμο με μεγάλη ποικιλία",
                        great_value: "Εξαιρετική σχέση ποιότητας-τιμής",
                        quiet_peaceful: "Το ξενοδοχείο ήταν υπέροχα ήσυχο και γαλήνιο",
                        modern_amenities: "Οι παροχές ήταν σύγχρονες και καλοδιατηρημένες",
                        opening_1: "Είχαμε μια υπέροχη διαμονή στο",
                        opening_2: "Απολαύσαμε πραγματικά τον χρόνο μας στο",
                        opening_3: "Εξαιρετική εμπειρία στο",
                        closing_1: "Συνιστώ ανεπιφύλακτα αυτό το ξενοδοχείο!",
                        closing_2: "Σίγουρα θα μείνουμε ξανά!",
                        closing_3: "Θα επιστρέψουμε σίγουρα!"
                    }
                };
                
                // Default to English for unsupported languages
                if (!this.translations[this.currentLang]) {
                    this.currentLang = 'en';
                }
            }

            detectLanguage() {
                // Check URL parameter first
                const params = new URLSearchParams(window.location.search);
                const urlLang = params.get('lang');
                if (urlLang && this.isSupported(urlLang)) {
                    return urlLang;
                }
                
                // Check localStorage
                const savedLang = localStorage.getItem('hotelReviewLang');
                if (savedLang && this.isSupported(savedLang)) {
                    return savedLang;
                }
                
                // Check browser language
                const browserLang = navigator.language.split('-')[0];
                if (this.isSupported(browserLang)) {
                    return browserLang;
                }
                
                return 'en'; // Default
            }

            isSupported(lang) {
                return lang in this.translations;
            }

            setLanguage(lang) {
                if (this.isSupported(lang)) {
                    this.currentLang = lang;
                    localStorage.setItem('hotelReviewLang', lang);
                    this.updateUI();
                    
                    // Update document direction for RTL languages
                    document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                    
                    return true;
                }
                return false;
            }

            t(key) {
                return this.translations[this.currentLang][key] || this.translations.en[key] || key;
            }

            updateUI() {
                // Update all elements with data-i18n attribute
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    element.textContent = this.t(key);
                });
                
                // Update placeholders
                document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-i18n-placeholder');
                    element.placeholder = this.t(key);
                });
                
                // Re-render aspects with translated text
                this.renderTranslatedAspects();
            }

            renderTranslatedAspects() {
                const grid = document.getElementById('aspects-grid');
                if (!grid) return;
                
                const aspects = [
                    'clean_rooms', 'comfortable_beds', 'great_location',
                    'friendly_staff', 'excellent_breakfast', 'great_value',
                    'quiet_peaceful', 'modern_amenities'
                ];
                
                grid.innerHTML = '';
                aspects.forEach(key => {
                    const item = document.createElement('div');
                    item.className = 'aspect-item';
                    item.innerHTML = `
                        <input type="checkbox" value="${key}" id="aspect-${key}">
                        <label for="aspect-${key}" style="flex: 1; cursor: pointer;">
                            ${this.t(key)}
                        </label>
                    `;
                    
                    item.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            const checkbox = item.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                            item.classList.toggle('selected', checkbox.checked);
                        } else {
                            item.classList.toggle('selected', e.target.checked);
                        }
                    });
                    
                    grid.appendChild(item);
                });
            }

            getLocalizedReviewTemplates() {
                return {
                    openings: [
                        this.t('opening_1'),
                        this.t('opening_2'),
                        this.t('opening_3')
                    ],
                    closings: [
                        this.t('closing_1'),
                        this.t('closing_2'),
                        this.t('closing_3')
                    ]
                };
            }
        }

        /**
         * Phase 3: Progressive Web App (PWA) Module
         * Offline support, installability, and app-like experience
         */
        class PWAManager {
            constructor() {
                this.deferredPrompt = null;
                this.isOnline = navigator.onLine;
                
                this.init();
            }

            init() {
                // Register service worker
                if ('serviceWorker' in navigator) {
                    this.registerServiceWorker();
                }
                
                // Handle install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallButton();
                });
                
                // Handle network status
                window.addEventListener('online', () => this.handleOnline());
                window.addEventListener('offline', () => this.handleOffline());
                
                // Handle app installed
                window.addEventListener('appinstalled', () => {
                    console.log('PWA installed successfully');
                    this.hideInstallButton();
                    window.HotelAnalytics?.trackEvent('pwa', 'installed', 'success');
                });
            }

            async registerServiceWorker() {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('ServiceWorker registered:', registration);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                this.showUpdateNotification();
                            }
                        });
                    });
                } catch (error) {
                    console.error('ServiceWorker registration failed:', error);
                }
            }

            showInstallButton() {
                const button = document.getElementById('install-button');
                if (button) {
                    button.style.display = 'block';
                    button.addEventListener('click', () => this.installApp());
                }
            }

            hideInstallButton() {
                const button = document.getElementById('install-button');
                if (button) {
                    button.style.display = 'none';
                }
            }

            async installApp() {
                if (!this.deferredPrompt) return;
                
                this.deferredPrompt.prompt();
                const { outcome } = await this.deferredPrompt.userChoice;
                
                console.log('Install prompt outcome:', outcome);
                window.HotelAnalytics?.trackEvent('pwa', 'install_prompt', outcome);
                
                this.deferredPrompt = null;
                
                if (outcome === 'accepted') {
                    this.hideInstallButton();
                }
            }

            handleOnline() {
                this.isOnline = true;
                const banner = document.getElementById('offline-banner');
                if (banner) {
                    banner.classList.remove('visible');
                }
                console.log('App is back online');
            }

            handleOffline() {
                this.isOnline = false;
                const banner = document.getElementById('offline-banner');
                if (banner) {
                    banner.classList.add('visible');
                }
                console.log('App is offline but functional');
            }

            showUpdateNotification() {
                if (confirm('A new version is available. Reload to update?')) {
                    window.location.reload();
                }
            }

            // Cache management for offline functionality
            async cacheAssets() {
                if (!('caches' in window)) return;
                
                try {
                    const cache = await caches.open('hotel-review-v1');
                    await cache.addAll([
                        '/',
                        '/manifest.json',
                        '/icon-192.png',
                        '/icon-512.png'
                    ]);
                    console.log('Assets cached for offline use');
                } catch (error) {
                    console.error('Caching failed:', error);
                }
            }
        }

        /**
         * Main Application Controller
         * Integrates all phases: Analytics, i18n, and PWA
         */
        class UltimateHotelReviewApp {
            constructor() {
                // Initialize modules
                this.analytics = new HotelAnalytics();
                this.i18n = new I18n();
                this.pwa = new PWAManager();
                
                // Configuration
                this.config = {
                    hotelName: 'Acme Hotel',
                    limits: {
                        staffNameMax: 100,
                        commentsMax: 500
                    }
                };
                
                this.init();
            }

            init() {
                // Track page view
                this.analytics.trackPageView();
                
                // Setup language selector
                this.setupLanguageSelector();
                
                // Initialize UI
                this.i18n.updateUI();
                this.setupEventListeners();
                this.setupCharacterCounters();
                
                // Track funnel start
                this.analytics.trackFunnelStep('page_loaded');
                
                console.log('Ultimate Hotel Review App initialized');
            }

            setupLanguageSelector() {
                const selector = document.getElementById('language-select');
                if (selector) {
                    selector.value = this.i18n.currentLang;
                    selector.addEventListener('change', (e) => {
                        this.i18n.setLanguage(e.target.value);
                        this.analytics.trackEvent('ui', 'language_changed', e.target.value);
                    });
                }
            }

            setupEventListeners() {
                // Generate button
                const generateBtn = document.getElementById('generate-btn');
                if (generateBtn) {
                    generateBtn.addEventListener('click', () => this.generateReview());
                }
                
                // Copy button
                const copyBtn = document.getElementById('copy-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => this.copyReview());
                }
                
                // Track aspect selections
                document.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        this.analytics.trackEvent('interaction', 'aspect_toggled', e.target.value);
                        this.analytics.trackFunnelStep('aspects_selected');
                    }
                });
            }

            setupCharacterCounters() {
                this.setupCounter('staff-name', 'staff-counter', this.config.limits.staffNameMax);
                this.setupCounter('comments', 'comments-counter', this.config.limits.commentsMax);
            }

            setupCounter(inputId, counterId, max) {
                const input = document.getElementById(inputId);
                const counter = document.getElementById(counterId);
                
                if (input && counter) {
                    input.addEventListener('input', () => {
                        const length = input.value.length;
                        counter.textContent = `${length}/${max}`;
                        
                        if (length > max * 0.8) {
                            counter.style.color = 'var(--warning)';
                        } else {
                            counter.style.color = 'var(--text-light)';
                        }
                    });
                }
            }

            generateReview() {
                // Get selected aspects
                const aspects = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
                
                if (aspects.length === 0) {
                    this.showError(this.i18n.t('error_no_aspects'));
                    return;
                }
                
                // Get inputs
                const staffName = document.getElementById('staff-name').value.trim();
                const comments = document.getElementById('comments').value.trim();
                
                // Build review with localized templates
                const templates = this.i18n.getLocalizedReviewTemplates();
                const opening = templates.openings[Math.floor(Math.random() * templates.openings.length)];
                const closing = templates.closings[Math.floor(Math.random() * templates.closings.length)];
                
                let review = `${opening} ${this.config.hotelName}! `;
                
                // Add aspects
                aspects.forEach((aspect, index) => {
                    review += this.i18n.t(aspect);
                    if (index < aspects.length - 1) review += ' ';
                });
                
                // Add staff recognition
                if (staffName) {
                    review += ` ${this.i18n.t('staff_recognition')} ${staffName}. `;
                }
                
                // Add comments
                if (comments) {
                    review += ` ${comments} `;
                }
                
                review += ` ${closing}`;
                
                // Display review
                document.getElementById('review-text').textContent = review;
                document.getElementById('review-output').classList.remove('hidden');
                
                // Track analytics
                this.analytics.trackReviewGenerated({
                    aspects,
                    hasStaffMention: !!staffName,
                    hasComments: !!comments,
                    language: this.i18n.currentLang
                });
                
                // Scroll to review
                document.getElementById('review-output').scrollIntoView({ behavior: 'smooth' });
            }

            async copyReview() {
                const reviewText = document.getElementById('review-text').textContent;
                
                try {
                    await navigator.clipboard.writeText(reviewText);
                    this.showNotification();
                    this.analytics.trackReviewCopied();
                } catch (err) {
                    console.error('Copy failed:', err);
                    this.fallbackCopy(reviewText);
                }
            }

            fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    document.execCommand('copy');
                    this.showNotification();
                    this.analytics.trackReviewCopied();
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                }
                
                document.body.removeChild(textarea);
            }

            showNotification() {
                const notification = document.getElementById('notification');
                if (notification) {
                    notification.classList.add('visible');
                    setTimeout(() => {
                        notification.classList.remove('visible');
                    }, 3000);
                }
            }

            showError(message) {
                const errorDisplay = document.getElementById('error-display');
                const errorText = document.getElementById('error-text');
                
                if (errorDisplay && errorText) {
                    errorText.textContent = message;
                    errorDisplay.classList.add('visible');
                    
                    setTimeout(() => {
                        errorDisplay.classList.remove('visible');
                    }, 5000);
                }
                
                this.analytics.trackEvent('error', 'validation', message);
            }
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Make analytics available globally for testing
            window.HotelAnalytics = HotelAnalytics;
            
            // Initialize the ultimate app
            window.hotelReviewApp = new UltimateHotelReviewApp();
            
            console.log('✨ Ultimate Hotel Review Generator loaded with Analytics, i18n, and PWA support');
        });
    </script>
</body>
</html>