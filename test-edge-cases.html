<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚨 Edge Case & Harsh Conditions Test</title>
    <style>
        body { 
            font-family: monospace; 
            background: #000; 
            color: #0f0; 
            padding: 20px;
        }
        .test { 
            border: 1px solid #333; 
            padding: 10px; 
            margin: 10px 0; 
        }
        .pass { 
            background: #001100; 
            border-color: #0f0; 
        }
        .fail { 
            background: #110000; 
            border-color: #f00; 
            color: #f00;
        }
        .warning { 
            background: #111100; 
            border-color: #ff0; 
            color: #ff0;
        }
    </style>
</head>
<body>
    <h1>🚨 EXTREME CONDITIONS TEST - Hotel Review Generator</h1>
    <p>Testing under harsh, edge-case scenarios...</p>
    
    <div id="results"></div>

    <script>
        const results = [];
        
        async function testExtremeConditions() {
            const tests = [
                testVeryLongInput,
                testEmptyInput,
                testSpecialCharacters,
                testUnicodeEmojis,
                testVerySlowNetwork,
                testMemoryStress,
                testRapidClicking,
                testBrokenHTML,
                testMalformedURLs,
                testClipboardFailure,
                testTouchEventStorm,
                testCSSBreakage
            ];
            
            for (const test of tests) {
                try {
                    const result = await test();
                    displayResult(result);
                } catch (error) {
                    displayResult({
                        name: test.name,
                        status: 'fail',
                        details: `Test crashed: ${error.message}`
                    });
                }
            }
            
            showSummary();
        }

        async function testVeryLongInput() {
            const iframe = await createTestFrame();
            const doc = iframe.contentDocument;
            
            // Create extremely long strings
            const veryLongText = 'A'.repeat(10000);
            const unicodeLongText = '🏨'.repeat(1000);
            
            try {
                // Test staff name field with very long input
                const staffInput = doc.getElementById('staff-name');
                staffInput.value = veryLongText;
                
                // Test comments field with very long input
                const commentsInput = doc.getElementById('comments');
                commentsInput.value = unicodeLongText;
                
                // Generate review
                const review = iframe.contentWindow.ReviewBuilder.generate();
                
                // Check if app still functions
                const stillWorks = review && review.length > 0;
                const reasonable = review.length < 50000; // Reasonable output size
                
                cleanup(iframe);
                
                return {
                    name: 'Very Long Input Test',
                    status: stillWorks && reasonable ? 'pass' : 'fail',
                    details: `Generated ${review.length} chars from ${veryLongText.length + unicodeLongText.length} input chars`
                };
            } catch (error) {
                cleanup(iframe);
                return {
                    name: 'Very Long Input Test',
                    status: 'fail',
                    details: `Error: ${error.message}`
                };
            }
        }

        async function testEmptyInput() {
            const iframe = await createTestFrame();
            const doc = iframe.contentDocument;
            
            try {
                // Leave all fields empty, no aspects selected
                const review = iframe.contentWindow.ReviewBuilder.generate();
                
                // Should still generate a basic review
                const hasContent = review && review.length > 20;
                const hasHotelName = review.includes('Acme Hotel');
                
                cleanup(iframe);
                
                return {
                    name: 'Empty Input Test',
                    status: hasContent && hasHotelName ? 'pass' : 'fail',
                    details: `Generated ${review ? review.length : 0} chars with no input`
                };
            } catch (error) {
                cleanup(iframe);
                return {
                    name: 'Empty Input Test',
                    status: 'fail',
                    details: `Error: ${error.message}`
                };
            }
        }

        async function testSpecialCharacters() {
            const iframe = await createTestFrame();
            const doc = iframe.contentDocument;
            
            try {
                // Test with special characters and potential injection attempts
                const specialChars = `'"<>&\`{}[]()+=!@#$%^&*~|\\`;
                const sqlInjection = `'; DROP TABLE reviews; --`;
                const htmlInjection = `<img src=x onerror=alert('XSS')>`;
                
                doc.getElementById('staff-name').value = specialChars;
                doc.getElementById('comments').value = sqlInjection + htmlInjection;
                
                const review = iframe.contentWindow.ReviewBuilder.generate();
                
                // Check for proper escaping
                const noScript = !review.includes('<script>');
                const noAlert = !review.includes('alert(');
                const noSQL = !review.includes('DROP TABLE');
                const hasContent = review && review.length > 0;
                
                cleanup(iframe);
                
                return {
                    name: 'Special Characters Test',
                    status: noScript && noAlert && noSQL && hasContent ? 'pass' : 'fail',
                    details: `Safe: ${noScript && noAlert && noSQL}, Content: ${hasContent}`
                };
            } catch (error) {
                cleanup(iframe);
                return {
                    name: 'Special Characters Test',
                    status: 'fail',
                    details: `Error: ${error.message}`
                };
            }
        }

        async function testUnicodeEmojis() {
            const iframe = await createTestFrame();
            const doc = iframe.contentDocument;
            
            try {
                // Test with various Unicode characters and emojis
                const unicodeText = '🏨🌟⭐️🎉🎊💎🏆🥇👑💝🌈🦄🔥💯✨🎯🚀💫⚡️🌟🎪🎭🎨🎼🎵🎶';
                const complexUnicode = 'Ĥôţël Ŕêvïëw Ģëñëŕäţöŕ 测试 اختبار тест';
                
                doc.getElementById('staff-name').value = unicodeText;
                doc.getElementById('comments').value = complexUnicode;
                
                const review = iframe.contentWindow.ReviewBuilder.generate();
                
                const preservesUnicode = review.includes('🏨') && review.includes('Ĥôţël');
                const hasContent = review && review.length > 0;
                
                cleanup(iframe);
                
                return {
                    name: 'Unicode & Emoji Test',
                    status: preservesUnicode && hasContent ? 'pass' : 'warning',
                    details: `Unicode preserved: ${preservesUnicode}, Content: ${hasContent}`
                };
            } catch (error) {
                cleanup(iframe);
                return {
                    name: 'Unicode & Emoji Test',
                    status: 'fail',
                    details: `Error: ${error.message}`
                };
            }
        }

        async function testVerySlowNetwork() {
            // Simulate slow network by delaying iframe load
            const startTime = Date.now();
            
            return new Promise((resolve) => {
                const iframe = document.createElement('iframe');
                iframe.src = 'hotel-review-generator.html?' + Math.random();
                iframe.style.display = 'none';
                
                // Simulate network delay
                setTimeout(() => {
                    iframe.onload = () => {
                        const loadTime = Date.now() - startTime;
                        
                        try {
                            // Test if app still works after delayed load
                            const doc = iframe.contentDocument;
                            const hasUI = doc.querySelector('#generate-btn') !== null;
                            
                            cleanup(iframe);
                            
                            resolve({
                                name: 'Slow Network Test',
                                status: hasUI ? 'pass' : 'fail',
                                details: `Loaded after ${loadTime}ms delay, UI functional: ${hasUI}`
                            });
                        } catch (error) {
                            cleanup(iframe);
                            resolve({
                                name: 'Slow Network Test',
                                status: 'fail',
                                details: `Error after ${loadTime}ms: ${error.message}`
                            });
                        }
                    };
                    
                    document.body.appendChild(iframe);
                }, 2000); // 2 second delay
            });
        }

        async function testMemoryStress() {
            const iframes = [];
            let created = 0;
            let errors = 0;
            
            try {
                // Create multiple instances to stress test memory
                for (let i = 0; i < 20; i++) {
                    try {
                        const iframe = document.createElement('iframe');
                        iframe.src = 'hotel-review-generator.html';
                        iframe.style.display = 'none';
                        document.body.appendChild(iframe);
                        iframes.push(iframe);
                        created++;
                        
                        // Small delay to prevent browser freeze
                        await new Promise(r => setTimeout(r, 50));
                    } catch (error) {
                        errors++;
                    }
                }
                
                // Clean up
                iframes.forEach(iframe => {
                    try {
                        document.body.removeChild(iframe);
                    } catch (e) {
                        errors++;
                    }
                });
                
                const success = created >= 15 && errors <= 5;
                
                return {
                    name: 'Memory Stress Test',
                    status: success ? 'pass' : 'warning',
                    details: `Created ${created}/20 instances, ${errors} errors`
                };
            } catch (error) {
                // Clean up any remaining iframes
                iframes.forEach(iframe => {
                    try {
                        document.body.removeChild(iframe);
                    } catch (e) {}
                });
                
                return {
                    name: 'Memory Stress Test',
                    status: 'fail',
                    details: `Test failed: ${error.message}`
                };
            }
        }

        async function testRapidClicking() {
            const iframe = await createTestFrame();
            const doc = iframe.contentDocument;
            
            try {
                const generateBtn = doc.getElementById('generate-btn');
                let clickCount = 0;
                let errors = 0;
                
                // Rapid fire clicking
                for (let i = 0; i < 50; i++) {
                    try {
                        generateBtn.click();
                        clickCount++;
                        
                        // Tiny delay
                        await new Promise(r => setTimeout(r, 10));
                    } catch (error) {
                        errors++;
                    }
                }
                
                // Check if UI is still responsive
                const reviewOutput = doc.getElementById('review-output');
                const stillVisible = !reviewOutput.classList.contains('hidden');
                
                cleanup(iframe);
                
                return {
                    name: 'Rapid Clicking Test',
                    status: stillVisible && errors < 10 ? 'pass' : 'warning',
                    details: `${clickCount} clicks, ${errors} errors, UI responsive: ${stillVisible}`
                };
            } catch (error) {
                cleanup(iframe);
                return {
                    name: 'Rapid Clicking Test',
                    status: 'fail',
                    details: `Error: ${error.message}`
                };
            }
        }

        async function testBrokenHTML() {
            // Test with intentionally malformed URL parameters
            const brokenUrls = [
                'hotel-review-generator.html?source="><script>alert("xss")</script>',
                'hotel-review-generator.html?source=' + encodeURIComponent('<>&"\''),
                'hotel-review-generator.html?' + 'x'.repeat(1000)
            ];
            
            let passed = 0;
            let total = brokenUrls.length;
            
            for (const url of brokenUrls) {
                try {
                    const iframe = document.createElement('iframe');
                    iframe.src = url;
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                    
                    await new Promise(resolve => {
                        iframe.onload = () => {
                            try {
                                const doc = iframe.contentDocument;
                                const hasContent = doc.body && doc.body.children.length > 0;
                                if (hasContent) passed++;
                            } catch (e) {}
                            
                            document.body.removeChild(iframe);
                            resolve();
                        };
                        
                        iframe.onerror = () => {
                            document.body.removeChild(iframe);
                            resolve();
                        };
                        
                        // Timeout
                        setTimeout(() => {
                            try {
                                document.body.removeChild(iframe);
                            } catch (e) {}
                            resolve();
                        }, 3000);
                    });
                } catch (error) {
                    // Expected for some malformed URLs
                }
            }
            
            return {
                name: 'Broken HTML Test',
                status: passed >= total * 0.7 ? 'pass' : 'warning',
                details: `${passed}/${total} malformed URLs handled gracefully`
            };
        }

        async function testMalformedURLs() {
            const malformedUrls = [
                'hotel-review-generator.html?source=',
                'hotel-review-generator.html?source',
                'hotel-review-generator.html?=booking',
                'hotel-review-generator.html?source=booking&source=expedia',
                'hotel-review-generator.html?' + 'a'.repeat(2000) + '=value'
            ];
            
            let handled = 0;
            
            for (const url of malformedUrls) {
                try {
                    const iframe = document.createElement('iframe');
                    iframe.src = url;
                    iframe.style.display = 'none';
                    
                    await new Promise(resolve => {
                        iframe.onload = () => {
                            try {
                                const win = iframe.contentWindow;
                                const source = win.BookingDetector ? win.BookingDetector.getSource() : null;
                                
                                // Should default to 'direct' for malformed URLs
                                if (source === 'direct') handled++;
                            } catch (e) {}
                            
                            cleanup(iframe);
                            resolve();
                        };
                        
                        iframe.onerror = () => {
                            cleanup(iframe);
                            resolve();
                        };
                        
                        document.body.appendChild(iframe);
                        
                        setTimeout(() => {
                            cleanup(iframe);
                            resolve();
                        }, 2000);
                    });
                } catch (error) {
                    // Some URLs might be completely invalid
                }
            }
            
            return {
                name: 'Malformed URL Test',
                status: handled >= 3 ? 'pass' : 'warning',
                details: `${handled}/${malformedUrls.length} malformed URLs handled properly`
            };
        }

        async function testClipboardFailure() {
            const iframe = await createTestFrame();
            
            try {
                const win = iframe.contentWindow;
                
                // Mock clipboard failure
                const originalClipboard = win.navigator.clipboard;
                win.navigator.clipboard = null;
                
                const originalExecCommand = win.document.execCommand;
                win.document.execCommand = () => false;
                
                // Try to copy
                let errorHandled = false;
                try {
                    await win.ClipboardManager.copy('test text');
                    errorHandled = true; // Should not throw, but handle gracefully
                } catch (error) {
                    errorHandled = true; // Or catch the error properly
                }
                
                // Restore
                win.navigator.clipboard = originalClipboard;
                win.document.execCommand = originalExecCommand;
                
                cleanup(iframe);
                
                return {
                    name: 'Clipboard Failure Test',
                    status: errorHandled ? 'pass' : 'fail',
                    details: `Clipboard failure handled gracefully: ${errorHandled}`
                };
            } catch (error) {
                cleanup(iframe);
                return {
                    name: 'Clipboard Failure Test',
                    status: 'warning',
                    details: `Test setup error: ${error.message}`
                };
            }
        }

        async function testTouchEventStorm() {
            const iframe = await createTestFrame();
            const doc = iframe.contentDocument;
            
            try {
                const checkboxes = doc.querySelectorAll('.checkbox-item');
                let eventCount = 0;
                let errors = 0;
                
                // Simulate rapid touch events
                for (let i = 0; i < 100; i++) {
                    try {
                        const randomCheckbox = checkboxes[Math.floor(Math.random() * checkboxes.length)];
                        
                        // Simulate touch events
                        const touchStart = new TouchEvent('touchstart', { bubbles: true });
                        const touchEnd = new TouchEvent('touchend', { bubbles: true });
                        const click = new MouseEvent('click', { bubbles: true });
                        
                        randomCheckbox.dispatchEvent(touchStart);
                        randomCheckbox.dispatchEvent(touchEnd);
                        randomCheckbox.dispatchEvent(click);
                        
                        eventCount += 3;
                    } catch (error) {
                        errors++;
                    }
                }
                
                // Check if checkboxes still work
                const firstCheckbox = checkboxes[0];
                firstCheckbox.click();
                const stillResponsive = firstCheckbox.classList.contains('checked');
                
                cleanup(iframe);
                
                return {
                    name: 'Touch Event Storm Test',
                    status: stillResponsive && errors < 20 ? 'pass' : 'warning',
                    details: `${eventCount} events fired, ${errors} errors, responsive: ${stillResponsive}`
                };
            } catch (error) {
                cleanup(iframe);
                return {
                    name: 'Touch Event Storm Test',
                    status: 'fail',
                    details: `Error: ${error.message}`
                };
            }
        }

        async function testCSSBreakage() {
            const iframe = await createTestFrame();
            const doc = iframe.contentDocument;
            
            try {
                // Inject broken CSS to test resilience
                const brokenCSS = `
                    <style>
                        * { display: invalid !important; }
                        .container { width: -999px; }
                        button { height: auto auto; }
                        @media screen and { color: red; }
                    </style>
                `;
                
                doc.head.insertAdjacentHTML('beforeend', brokenCSS);
                
                // Test if core functionality still works
                const generateBtn = doc.getElementById('generate-btn');
                const isClickable = generateBtn && getComputedStyle(generateBtn).display !== 'none';
                
                generateBtn.click();
                const reviewOutput = doc.getElementById('review-output');
                const generationWorks = !reviewOutput.classList.contains('hidden');
                
                cleanup(iframe);
                
                return {
                    name: 'CSS Breakage Test',
                    status: isClickable && generationWorks ? 'pass' : 'warning',
                    details: `Button clickable: ${isClickable}, Generation works: ${generationWorks}`
                };
            } catch (error) {
                cleanup(iframe);
                return {
                    name: 'CSS Breakage Test',
                    status: 'fail',
                    details: `Error: ${error.message}`
                };
            }
        }

        // Helper functions
        async function createTestFrame() {
            return new Promise((resolve) => {
                const iframe = document.createElement('iframe');
                iframe.src = 'hotel-review-generator.html';
                iframe.style.display = 'none';
                
                iframe.onload = () => {
                    resolve(iframe);
                };
                
                document.body.appendChild(iframe);
            });
        }

        function cleanup(iframe) {
            try {
                document.body.removeChild(iframe);
            } catch (e) {}
        }

        function displayResult(result) {
            results.push(result);
            
            const div = document.createElement('div');
            div.className = `test ${result.status}`;
            div.innerHTML = `
                <h3>${result.name} - ${result.status.toUpperCase()}</h3>
                <p>${result.details}</p>
            `;
            
            document.getElementById('results').appendChild(div);
        }

        function showSummary() {
            const passed = results.filter(r => r.status === 'pass').length;
            const failed = results.filter(r => r.status === 'fail').length;
            const warnings = results.filter(r => r.status === 'warning').length;
            
            const summary = document.createElement('div');
            summary.className = 'test pass';
            summary.innerHTML = `
                <h2>🚨 EXTREME CONDITIONS TEST SUMMARY</h2>
                <p><strong>Total Tests:</strong> ${results.length}</p>
                <p><strong>Passed:</strong> ${passed} ✅</p>
                <p><strong>Warnings:</strong> ${warnings} ⚠️</p>
                <p><strong>Failed:</strong> ${failed} ❌</p>
                <p><strong>Success Rate:</strong> ${((passed / results.length) * 100).toFixed(1)}%</p>
                <p><strong>Overall Status:</strong> ${failed === 0 ? 'ROBUST 💪' : failed <= 2 ? 'RESILIENT 🛡️' : 'NEEDS HARDENING 🔧'}</p>
            `;
            
            document.getElementById('results').appendChild(summary);
        }

        // Start tests immediately
        document.addEventListener('DOMContentLoaded', testExtremeConditions);
    </script>
</body>
</html>